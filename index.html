<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard √Åudio - Bola de Neve Sorocaba</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
    body {
        font-family: 'Inter', sans-serif;
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        color: #f8fafc;
        min-height: 100vh;
    }
    .glass-card {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 16px;
        height: 100%;
    }

    .fc { font-size: 0.85rem; }
    .fc .fc-col-header-cell-cushion { color: black !important; font-weight: 600; }
    .fc .fc-daygrid-day-number { color: #e5e7eb !important; font-weight: 600; }
    .fc .fc-event-main { color: #f9fafb !important; }
    .fc-toolbar-title { color: #fbbf24 !important; font-size: 1.1rem !important; font-weight: 800; }
    .fc-button-primary { background-color: rgba(255,255,255,0.1) !important; border: none !important; color: #e5e7eb !important; }
    .fc-event { border-radius: 4px !important; padding: 2px !important; border: none !important; }
    .fc-event-title { white-space: normal !important; line-height: 1.1; }
    
    input, select { 
        background: rgba(0,0,0,0.3) !important; 
        color: white !important; 
        border: 1px solid rgba(255,255,255,0.1) !important; 
        padding: 8px;
        border-radius: 8px;
        width: 100%;
        outline: none;
    }
    input:focus { border-color: #fbbf24 !important; }
    option { background: #1e293b; color: white; }

    .custom-scroll::-webkit-scrollbar { width: 6px; }
    .custom-scroll::-webkit-scrollbar-track { background: transparent; }
    .custom-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
    
    /* Estilo para esconder o modal */
    .modal-hidden { display: none !important; }
</style>

</head>
<body class="p-4 md:p-6">

    <header class="max-w-[1600px] mx-auto mb-6 flex flex-col md:flex-row justify-between items-center gap-4">
        <div class="text-center md:text-left">
            <h1 class="text-2xl md:text-3xl font-black italic text-yellow-500 tracking-tighter uppercase leading-none">Minist√©rio de √Åudio</h1>
            <p class="text-[10px] tracking-[0.4em] text-gray-400 uppercase">Bola de Neve Sorocaba</p>
        </div>
        <div class="flex items-center gap-4 bg-white/5 px-4 py-2 rounded-full border border-white/10">
            <span class="flex h-2 w-2 rounded-full bg-green-500"></span>
            <span class="text-xs font-bold uppercase tracking-widest text-gray-300">Painel de Controle Ativo</span>
        </div>
    </header>

    <main class="max-w-[1600px] mx-auto grid grid-cols-1 lg:grid-cols-12 gap-6">
        <div class="lg:col-span-7 xl:col-span-8">
            <div class="glass-card p-4 shadow-2xl">
                <div id="calendar"></div>
            </div>
        </div>

        <div class="lg:col-span-5 xl:col-span-4 flex flex-col gap-6">
            <div class="glass-card p-5 flex flex-col h-[400px]">
                <h2 class="text-sm font-bold mb-4 text-yellow-500 uppercase tracking-widest flex justify-between">
                    Pr√≥ximas Escalas <span>üìÖ</span>
                </h2>
                <div id="listaEscalas" class="flex-grow overflow-y-auto custom-scroll space-y-3 pr-2"></div>
            </div>

            <div class="grid grid-cols-1 gap-6">
                <div class="glass-card p-5">
                    <h2 class="text-sm font-bold mb-4 text-blue-400 uppercase tracking-widest">Agendar Culto ‚ûï</h2>
                    <div class="space-y-3">
                        <div class="grid grid-cols-2 gap-2">
                            <input id="dataCulto" type="date">
                            <select id="tipoCulto">
                                <option value="Quinta">Quinta</option>
                                <option value="Domingo Manh√£">Dom. Manh√£</option>
                                <option value="Domingo Noite">Dom. Noite</option>
                                <option value="Extra">Extra</option>
                            </select>
                        </div>
                        <input id="tituloEscala" type="text" placeholder="Nome da Escala (Ex: Santa Ceia)">
                        <select id="selectMembros"></select>
                        <button id="btnEscala" class="w-full bg-blue-600 py-2 rounded-lg font-black hover:bg-blue-500 transition-all text-sm uppercase">Salvar Escala</button>
                    </div>
                </div>

                <div class="glass-card p-5">
                    <h2 class="text-sm font-bold mb-4 text-green-400 uppercase tracking-widest">Equipe üë•</h2>
                    <div class="flex gap-2 mb-4">
                        <input id="nomeMembro" type="text" placeholder="Novo integrante" class="text-sm">
                        <button id="btnMembro" class="bg-green-600 px-4 py-2 rounded-lg font-bold hover:bg-green-500 text-xs">ADD</button>
                    </div>
                    <ul id="listaMembros" class="grid grid-cols-2 gap-2 max-h-[120px] overflow-y-auto custom-scroll pr-2"></ul>
                </div>
            </div>
        </div>
    </main>

    <div id="modalEditar" class="modal-hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
        <div class="glass-card p-6 w-full max-w-sm border-yellow-500/30 h-auto">
            <h2 class="text-yellow-500 font-bold mb-4 uppercase tracking-widest text-sm text-center">Alterar Respons√°vel</h2>
            <input type="hidden" id="editEscalaId">
            <div class="mb-6">
                <label class="text-[10px] text-gray-400 uppercase mb-2 block">Selecione o Integrante:</label>
                <select id="editSelectMembro"></select>
            </div>
            <div class="flex gap-2">
                <button onclick="window.fecharModal()" class="flex-1 bg-white/10 py-2 rounded-lg font-bold text-xs uppercase hover:bg-white/20 transition-colors">Cancelar</button>
                <button id="btnSalvarEdicao" class="flex-1 bg-yellow-500 py-2 rounded-lg font-bold text-xs uppercase text-black hover:bg-yellow-400 transition-colors">Salvar</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, updateDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCeArSQ8R9W8japktjIfdigLkWldcqTyF0",
            authDomain: "escala-audio-bola-de-neve.firebaseapp.com",
            projectId: "escala-audio-bola-de-neve",
            storageBucket: "escala-audio-bola-de-neve.firebasestorage.app",
            messagingSenderId: "200217286724",
            appId: "1:200217286724:web:8ab4bef67cf53f2fec0411",
            measurementId: "G-2FMTJVEHVH"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        let calendar;
        let listaNomesGlobal = [];

        document.addEventListener('DOMContentLoaded', () => {
            const calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                height: 'auto',
                locale: 'pt-br',
                headerToolbar: { left: 'prev,next', center: 'title', right: 'today' },
                events: []
            });
            calendar.render();
        });

        // Membros Realtime
        onSnapshot(collection(db, "membros"), (snap) => {
            const listaM = document.getElementById('listaMembros');
            const selectM = document.getElementById('selectMembros');
            listaM.innerHTML = ''; 
            listaNomesGlobal = [];
            selectM.innerHTML = '<option value="">Selecionar Membro...</option><option value="VAGO">-- VAGO --</option>';
            
            snap.forEach(d => {
                const m = d.data().nome; 
                listaNomesGlobal.push(m);
                listaM.innerHTML += `
                    <li class="bg-white/5 p-2 rounded-lg flex justify-between items-center border border-white/5">
                        <span class="text-[11px] font-semibold truncate mr-2">${m}</span>
                        <button onclick="window.removerMembro('${d.id}')" class="text-red-500 hover:text-red-400">
                            <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"/></svg>
                        </button>
                    </li>`;
                selectM.innerHTML += `<option value="${m}">${m}</option>`;
            });
        });

        // Escalas Realtime
        onSnapshot(query(collection(db, "escalas"), orderBy("data", "asc")), (snap) => {
            const listaE = document.getElementById('listaEscalas');
            listaE.innerHTML = '';
            const calendarEvents = [];
            const hoje = new Date(); hoje.setHours(0,0,0,0);

            const normalizarTipo = (tipoBruto) => {
                if (!tipoBruto) return "Extra";
                const t = tipoBruto.toLowerCase().trim();
                if (t.startsWith("quinta")) return "Quinta";
                if (t.startsWith("dom")) {
                    if (t.includes("manh")) return "Domingo Manh√£";
                    if (t.includes("noit")) return "Domingo Noite";
                    return "Domingo Manh√£";
                }
                return "Extra";
            };

            const escalas = [];
            snap.forEach(d => {
                const data = d.data();
                escalas.push({
                    id: d.id,
                    ...data,
                    tipoNormalizado: normalizarTipo(data.tipo)
                });
            });

            const tiposOrdem = ["Quinta", "Domingo Manh√£", "Domingo Noite", "Extra"];
            const grupos = { "Quinta": [], "Domingo Manh√£": [], "Domingo Noite": [], "Extra": [] };

            escalas.forEach(e => {
                const dataEscala = new Date(e.data + "T00:00:00");
                const tipo = e.tipoNormalizado;
                if (dataEscala >= hoje) { grupos[tipo].push(e); }
                calendarEvents.push({
                    title: e.titulo ? `${e.responsavel}\n(${e.titulo})` : e.responsavel,
                    start: e.data,
                    backgroundColor: e.responsavel === "VAGO" ? "#ef4444" : "#1e40af",
                    borderColor: 'transparent'
                });
            });

            tiposOrdem.forEach(tipo => {
                const listaTipo = grupos[tipo];
                if (!listaTipo || listaTipo.length === 0) return;
                listaE.innerHTML += `<div class="mt-2 mb-1"><h3 class="text-[10px] font-bold uppercase tracking-widest text-gray-300">${tipo}</h3></div>`;
                listaTipo.forEach(e => {
                    const dataEscala = new Date(e.data + "T00:00:00");
                    const dataF = dataEscala.toLocaleDateString('pt-BR');
                    const isVago = e.responsavel === "VAGO";
                    listaE.innerHTML += `
                        <div class="bg-white/5 p-3 rounded-xl border-l-4 ${isVago ? 'border-red-500' : 'border-yellow-500'} flex justify-between items-center transition-all hover:bg-white/10">
                            <div class="overflow-hidden mr-2">
                                <p class="text-[9px] text-gray-400 font-bold uppercase tracking-tighter">${dataF} ‚Ä¢ ${e.tipoNormalizado}</p>
                                <h3 class="text-sm font-black truncate ${isVago ? 'text-red-500' : 'text-white'}">${e.responsavel}</h3>
                                <p class="text-[10px] italic text-gray-500 truncate">${e.titulo || ''}</p>
                            </div>
                            <div class="flex gap-1 shrink-0">
                                <button onclick="window.editarEscala('${e.id}', '${e.responsavel}')" class="bg-yellow-500/20 text-yellow-500 p-1.5 rounded text-[9px] font-bold">EDIT</button>
                                <button onclick="window.remover('${e.id}')" class="bg-red-500/20 text-red-500 p-1.5 rounded text-[9px] font-bold uppercase">X</button>
                            </div>
                        </div>`;
                });
            });

            if (calendar) {
                calendar.removeAllEvents();
                calendar.addEventSource(calendarEvents);
            }
        });

        // Actions
        document.getElementById('btnEscala').onclick = async () => {
            const data = document.getElementById('dataCulto').value;
            const resp = document.getElementById('selectMembros').value || "VAGO";
            if (data) {
                await addDoc(collection(db, "escalas"), { 
                    data, 
                    tipo: document.getElementById('tipoCulto').value, 
                    titulo: document.getElementById('tituloEscala').value, 
                    responsavel: resp 
                });
                document.getElementById('tituloEscala').value = "";
                document.getElementById('dataCulto').value = "";
            }
        };

        document.getElementById('btnMembro').onclick = async () => {
            const n = document.getElementById('nomeMembro').value;
            if (n) { await addDoc(collection(db, "membros"), { nome: n }); document.getElementById('nomeMembro').value = ''; }
        };

        // Fun√ß√µes de Edi√ß√£o com Modal
        window.editarEscala = (id, atual) => {
            const modal = document.getElementById('modalEditar');
            const selectEdit = document.getElementById('editSelectMembro');
            document.getElementById('editEscalaId').value = id;
            
            // Popula o select do modal
            selectEdit.innerHTML = '<option value="VAGO">-- VAGO --</option>';
            listaNomesGlobal.forEach(nome => {
                const selected = nome === atual ? 'selected' : '';
                selectEdit.innerHTML += `<option value="${nome}" ${selected}>${nome}</option>`;
            });

            modal.classList.remove('modal-hidden');
        };

        window.fecharModal = () => {
            document.getElementById('modalEditar').classList.add('modal-hidden');
        };

        document.getElementById('btnSalvarEdicao').onclick = async () => {
            const id = document.getElementById('editEscalaId').value;
            const novoResponsavel = document.getElementById('editSelectMembro').value;
            await updateDoc(doc(db, "escalas", id), { responsavel: novoResponsavel });
            window.fecharModal();
        };

        window.remover = async (id) => { if(confirm("Excluir escala?")) await deleteDoc(doc(db, "escalas", id)); };
        window.removerMembro = async (id) => { if(confirm("Excluir membro?")) await deleteDoc(doc(db, "membros", id)); };

    </script>
</body>
</html>
